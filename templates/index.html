<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SCHBC BBMS - í˜ˆì•¡ ì¬ê³  ê´€ë¦¬</title>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            width: 100%;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            background: #f0f2f5;
            -webkit-text-size-adjust: 100%;
        }

        body {
            padding: 6px;
        }

        .container {
            width: 100%;
            max-width: 760px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            overflow: hidden;
        }

        /* â”€â”€ í—¤ë” â”€â”€ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            text-align: center;
        }

        .header h1 {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .header p {
            font-size: 11px;
            opacity: 0.9;
        }

        /* â”€â”€ ë¡œê·¸ì¸ â”€â”€ */
        .login-section {
            display: none;
            padding: 10px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .login-section.active {
            display: block;
        }

        .login-form {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .login-form input {
            flex: 1 1 100px;
            min-width: 80px;
            padding: 9px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: auto;
        }

        .login-form button {
            flex: 0 0 auto;
            padding: 9px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            width: auto;
        }

        .login-form button:active {
            background: #5568d3;
        }

        /* â”€â”€ ì‚¬ìš©ì ì •ë³´ â”€â”€ */
        .user-info {
            display: none;
            padding: 7px 12px;
            background: #e8f5e9;
            align-items: center;
            justify-content: space-between;
        }

        .user-info.active {
            display: flex;
        }

        .logout-btn {
            background: none;
            border: 1px solid #aaa;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 12px;
            cursor: pointer;
            color: #555;
            white-space: nowrap;
        }

        /* â”€â”€ ë©”ì‹œì§€ / ë¡œë”© â”€â”€ */
        .message {
            display: none;
            padding: 9px 12px;
            margin: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.active {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 12px;
            color: #667eea;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 0.9s linear infinite;
            margin: 0 auto 6px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* â”€â”€ ë§¤íŠ¸ë¦­ìŠ¤ í…Œì´ë¸” â”€â”€ */
        .grid-section {
            padding: 8px 6px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .grid-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            /* ëª¨ë°”ì¼ì—ì„œ ìµœì†Œ ë„ˆë¹„ í™•ë³´ */
            min-width: 320px;
        }

        /* ì œì œëª… ì—´ (ì²« ë²ˆì§¸ ì—´) */
        .grid-table th.prep-header {
            background: #f0f2ff;
            padding: 6px 2px;
            text-align: left;
            font-weight: 700;
            border: 1px solid #d0d0e8;
            font-size: 10px;
            color: #444;
            white-space: nowrap;
            /* ê³ ì • ë„ˆë¹„ (ê¸°ì¡´ì˜ 1.5ë°° ì´ìƒ í™•ë³´) */
            min-width: 50px;
            max-width: 50px;
            width: 50px;
        }

        /* í˜ˆì•¡í˜• ì—´ í—¤ë” */
        .grid-table th.bt-header {
            padding: 6px 2px;
            text-align: center;
            font-weight: 700;
            border: 1px solid #d0d0e8;
            font-size: 12px;
            white-space: nowrap;
        }

        .grid-table th.bt-header.bt-A {
            background: #fff3e0;
            color: #e65100;
        }

        /* ì˜¤ë Œì§€ */
        .grid-table th.bt-header.bt-B {
            background: #fde8e8;
            color: #b71c1c;
        }

        /* ë ˆë“œ   */
        .grid-table th.bt-header.bt-O {
            background: #e3f0ff;
            color: #0d47a1;
        }

        /* ë¸”ë£¨   */
        .grid-table th.bt-header.bt-AB {
            background: #eeeeee;
            color: #212121;
        }

        /* ë¸”ë™   */
        .grid-table td {
            padding: 3px 2px;
            border: 1px solid #e0e0e0;
            text-align: center;
            vertical-align: middle;
        }

        .grid-table td.prep-cell {
            background: #f5f5f5;
            font-weight: 700;
            font-size: 10px;
            text-align: left;
            padding-left: 3px;
            white-space: nowrap;
            min-width: 26px;
            max-width: 26px;
            width: 26px;
            overflow: hidden;
        }

        .grid-table td.prep-cell.custom-row {
            background: #f0f7ff;
            font-style: italic;
            font-size: 10px;
        }

        /* â”€â”€ ì…ë ¥ ì…€ â€” ëŒ€í­ ì¶•ì†Œ â”€â”€ */
        .qty-cell {
            padding: 2px !important;
            width: 60px;
            min-width: 48px;
            max-width: 72px;
        }

        .qty-wrap {
            display: flex;
            align-items: center;
            gap: 1px;
        }

        .qty-btn {
            width: 18px;
            height: 26px;
            flex-shrink: 0;
            border: 1px solid #bbb;
            border-radius: 3px;
            background: #f5f5f5;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            color: #444;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        .qty-btn:active {
            background: #dde;
        }

        .qty-input {
            flex: 1;
            min-width: 0;
            width: 100%;
            padding: 4px 1px;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            appearance: textfield;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        .qty-input:focus {
            outline: none;
            border-color: #667eea;
            background: #f0f4ff;
        }

        .qty-input::-webkit-inner-spin-button,
        .qty-input::-webkit-outer-spin-button {
            appearance: none;
            -webkit-appearance: none;
            margin: 0;
        }

        /* â”€â”€ ì‹ ì²­ëŸ‰ í–‰ â”€â”€ */
        .req-row td {
            background: #fffde7;
            font-size: 10px;
            padding: 2px 3px;
            color: #6b4500;
        }

        .req-row td.prep-cell {
            background: #fff8e1;
            font-size: 10px;
            color: #aaa;
            font-style: normal;
        }

        .req-val {
            font-size: 12px;
            color: #c84000;
            font-weight: 700;
        }

        .req-val.ok {
            color: #2e7d32;
        }

        .req-val.zero {
            color: #bbb;
        }

        /* â”€â”€ ì œì œ ì¶”ê°€ ë²„íŠ¼ â”€â”€ */
        .add-prep-section {
            padding: 6px 8px;
            border-top: 1px dashed #ddd;
        }

        .add-prep-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: #f0f4ff;
            border: 1px dashed #667eea;
            border-radius: 6px;
            color: #667eea;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            width: auto;
        }

        .add-prep-btn:active {
            background: #e0e8ff;
        }

        /* ì»¤ìŠ¤í…€ ì œì œ ì¶”ê°€ í¼ */
        .add-prep-form {
            display: none;
            margin-top: 6px;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .add-prep-form.active {
            display: flex;
        }

        .add-prep-form select {
            flex: 1 1 120px;
            padding: 7px 10px;
            border: 1px solid #c9bef0;
            border-radius: 6px;
            font-size: 13px;
            min-width: 120px;
            background: white;
        }

        .add-prep-confirm {
            padding: 7px 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }

        .add-prep-cancel {
            padding: 7px 10px;
            background: #e0e0e0;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }

        /* â”€â”€ í•˜ë‹¨ â”€â”€ */
        .bottom-section {
            padding: 10px 12px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .remark-group {
            margin-bottom: 8px;
        }

        .remark-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            font-size: 12px;
            color: #555;
        }

        .remark-group textarea {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            resize: vertical;
            min-height: 48px;
            font-family: inherit;
        }

        .button-group {
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s;
            width: auto;
            min-width: 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.97);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        /* â”€â”€ ê´€ë¦¬ì íŒ¨ë„ (PC ì „ìš© â‰¥768px) â”€â”€ */
        .admin-panel {
            display: none;
            padding: 12px 14px;
            border-top: 2px solid #667eea;
            background: #f5f3ff;
        }

        .admin-panel h3 {
            font-size: 13px;
            color: #5541a8;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .admin-field label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #555;
            margin-bottom: 3px;
        }

        .admin-field input {
            width: 100%;
            padding: 7px 9px;
            border: 1px solid #c9bef0;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }

        .admin-reason label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #555;
            margin-bottom: 3px;
        }

        .admin-reason textarea {
            width: 100%;
            padding: 7px 9px;
            border: 1px solid #c9bef0;
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
            min-height: 42px;
            resize: vertical;
            background: white;
        }

        .admin-apply-btn {
            margin-top: 8px;
            padding: 8px 16px;
            background: #5541a8;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .admin-apply-btn:active {
            background: #3d2f8a;
        }

        .admin-hint {
            font-size: 10px;
            color: #888;
            margin-top: 5px;
            line-height: 1.5;
        }

        @media (min-width: 768px) {
            .admin-panel {
                display: block;
            }
        }

        /* â”€â”€ ëª¨ë°”ì¼ ì‘ê¸‰ ë³´ì • â”€â”€ */
        @media (max-width: 400px) {
            body {
                padding: 3px;
            }

            .qty-btn {
                width: 16px;
                font-size: 13px;
            }

            .qty-input {
                font-size: 12px;
            }

            .btn {
                font-size: 13px;
                padding: 10px 6px;
            }
        }

        /* â”€â”€ ëª¨ë‹¬ ê¸°ë³¸ â”€â”€ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #fff;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            padding: 16px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        .modal-header h2 {
            font-size: 16px;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .user-table th,
        .user-table td {
            border: 1px solid #eee;
            padding: 6px;
            text-align: center;
        }

        .user-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }

        .btn-primary {
            background: #667eea;
            color: #fff;
        }

        .btn-danger {
            background: #dc3545;
            color: #fff;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .user-form {
            display: grid;
            gap: 8px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
        }

        .user-form input,
        .user-form select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸ©¸ SCHBC BBMS</h1>
            <p>í˜ˆì•¡ ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
        </div>

        <!-- ë¡œê·¸ì¸ -->
        <div class="login-section active" id="loginSection">
            <form class="login-form" id="loginForm">
                <input type="text" id="empId" placeholder="ì‚¬ë²ˆ" autocomplete="username" required>
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" required>
                <button type="submit">ë¡œê·¸ì¸</button>
            </form>
        </div>

        <!-- ì‚¬ìš©ì ì •ë³´ -->
        <div class="user-info" id="userInfo">
            <span id="userName" style="font-size:13px;font-weight:600;"></span>
            <div>
                <button class="logout-btn" id="btnAnalytics" onclick="window.location.href='/analytics'"
                    style="display:none; margin-right:5px; background: #667eea; color: white; border-color: #667eea;">ğŸ“Š
                    í†µê³„ ëŒ€ì‹œë³´ë“œ</button>
                <button class="logout-btn" id="btnUserManager" onclick="openUserModal()"
                    style="display:none; margin-right:5px; background: #5541a8; color: white; border-color: #5541a8;">ğŸ‘¥
                    ì‚¬ìš©ì ê´€ë¦¬ (ë“±ë¡/ê¶Œí•œ)</button>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="message" id="message"></div>

        <!-- ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë‹¬ -->
        <div class="modal-overlay" id="userModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</h2>
                    <button class="modal-close" onclick="closeUserModal()">&times;</button>
                </div>

                <table class="user-table" id="userTable">
                    <thead>
                        <tr>
                            <th>ì‚¬ë²ˆ</th>
                            <th>ì´ë¦„</th>
                            <th>ê¶Œí•œ</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <div class="user-form">
                    <h3 style="font-size:14px; margin-bottom:4px;">â• ìƒˆ ì‚¬ìš©ì ë“±ë¡</h3>
                    <input type="text" id="newEmpId" placeholder="ì‚¬ë²ˆ (í•„ìˆ˜)">
                    <input type="text" id="newName" placeholder="ì´ë¦„ (í•„ìˆ˜)">
                    <input type="password" id="newPassword" placeholder="ê¸°ì´ˆ ë¹„ë°€ë²ˆí˜¸ (í•„ìˆ˜)">
                    <select id="newRole">
                        <option value="0">ì¼ë°˜ ì‚¬ìš©ì</option>
                        <option value="1">ê´€ë¦¬ì</option>
                    </select>
                    <button class="btn-small btn-primary" onclick="createUser()">ë“±ë¡</button>
                </div>
            </div>
        </div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div style="font-size:13px;">ì²˜ë¦¬ ì¤‘...</div>
        </div>

        <!-- â”€â”€ ë§¤íŠ¸ë¦­ìŠ¤ í…Œì´ë¸” (ì œì œ=í–‰, í˜ˆì•¡í˜•=ì—´) â”€â”€ -->
        <div class="grid-section">
            <table class="grid-table" id="gridTable">
                <thead id="gridHead"></thead>
                <tbody id="gridBody"></tbody>
            </table>
        </div>

        <!-- ì œì œ ì¶”ê°€ -->
        <div class="add-prep-section">
            <button class="add-prep-btn" onclick="showAddPrepForm()">â• ì œì œ ì¶”ê°€</button>
            <div class="add-prep-form" id="addPrepForm">
                <select id="newPrepName">
                    <option value="">-- ì œì œ ì„ íƒ --</option>
                    <option value="Washed PLT">Washed PLT</option>
                    <option value="Rh-PRBC">Rh-PRBC</option>
                    <option value="Rh-FFP">Rh-FFP</option>
                    <option value="Rh-SDP">Rh-SDP</option>
                    <option value="Rh-PC">Rh-PC</option>
                    <option value="Rh-PreR">Rh-PreR</option>
                </select>
                <button class="add-prep-confirm" onclick="confirmAddPrep()">ì¶”ê°€</button>
                <button class="add-prep-cancel" onclick="hideAddPrepForm()">ì·¨ì†Œ</button>
            </div>
        </div>

        <!-- í•˜ë‹¨ -->
        <div class="bottom-section">
            <div class="audit-group" style="margin-bottom: 8px; font-size: 13px; font-weight: 600;">
                <label style="cursor: pointer;"><input type="checkbox" id="expiryOk" checked> ìœ íš¨ê¸°ê°„ í™•ì¸(OK)</label>
                <label style="cursor: pointer; margin-left: 14px;"><input type="checkbox" id="visualOk" checked> ìœ¡ì•ˆ
                    í™•ì¸(OK)</label>
            </div>
            <div class="remark-group">
                <label for="remark">ë¹„ê³ </label>
                <textarea id="remark" placeholder="ì…ì¶œê³  ì‚¬ìœ , íŠ¹ì´ì‚¬í•­ ë“± (ì„ íƒì‚¬í•­)"></textarea>
            </div>
            <div class="button-group">
                <input type="file" id="excelFileInput" accept=".xls,.xlsx" multiple style="display:none;"
                    onchange="handleExcelUpload(event)">
                <button class="btn btn-secondary" onclick="document.getElementById('excelFileInput').click()"
                    style="background:#28a745; color:#fff; border-color:#28a745;">Excel ì—‘ì…€ì…ê³ í†µê³„(ë¶„ì„ìš©)</button>
                <button class="btn btn-secondary" onclick="clearQty()">ìˆ˜ëŸ‰ ì´ˆê¸°í™”</button>
                <button class="btn btn-primary" onclick="submitForm()">ì¬ê³  ì‹¤ì‚¬ ì €ì¥</button>
            </div>
        </div>

        <!-- RBC ì¬ê³ ë¹„ íŒ¨ë„ -->
        <div class="admin-panel" id="adminPanel">
            <h3>âš™ï¸ í˜ˆì•¡í˜•ë³„ RBC ì¬ê³ ë¹„ ì„¤ì •</h3>
            <div id="rbcConfigContainer" style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px;">
                <!-- JSì—ì„œ 4ê°œ í˜ˆì•¡í˜• ë¡œìš° ìƒì„± -->
            </div>
            <div class="admin-reason">
                <label for="adminReason">ì¬ê³ ë¹„ ë³€ê²½ì‚¬ìœ  (5ì ì´ìƒ í•„ìˆ˜)</label>
                <textarea id="adminReason" placeholder="ì˜ˆ: 2026ë…„ 2ë¶„ê¸° ì‚¬ìš©ëŸ‰ ë¶„ì„ ë°˜ì˜"></textarea>
            </div>

            <button class="admin-apply-btn" onclick="saveAllRbcFactors()"
                style="width:100%; padding:12px; background:#5541a8; color:#fff; border:none; border-radius:6px; font-size:14px; cursor:pointer; font-weight:bold; margin-bottom:10px;">ğŸ“Š
                ì „ì²´(A, B, O, AB) ì¬ê³ ë¹„ ë™ì‹œ ì €ì¥</button>

            <p class="admin-hint">ğŸ’¡ ì ì •ì¬ê³  = ceil(DCR Ã— SF) | Oí˜• RBC: +4<br>
                â€» 1ì¼ ì¬ê³ (DCR)ëŠ” ê´€ë¦¬ìë§Œ ìˆ˜ì • ê°€ëŠ¥. ìœ„í—˜ì¬ê³ ë¹„(DF) ë¯¸ë§Œ ì‹œ ì•ŒëŒ ë°œì†¡.</p>
        </div>
        <!-- ìœ„í—˜ì¬ê³  ì•ŒëŒ ì´ë©”ì¼ ê´€ë¦¬ íŒ¨ë„ -->
        <div id="emailConfigSection" class="admin-section" style="display:none; margin-top: 10px;">
            <div class="admin-panel" style="border:1.5px solid #f5a5a5; background:#fff8f8;">
                <div class="admin-header" style="color:#dc3545;">ğŸš¨ ìœ„í—˜ì¬ê³  ì•ŒëŒ ì´ë©”ì¼ ê´€ë¦¬</div>
                <p style="font-size:12px; color:#666; margin:0 0 10px;">RBC ì¬ê³ ê°€ ìœ„í—˜ì¬ê³ ë¹„(DF) ë¯¸ë§Œ ì‹œ ì•„ë˜ ë“±ë¡ëœ ì´ë©”ì¼ë¡œ ìë™ ë°œì†¡ë©ë‹ˆë‹¤.</p>
                <div id="emailListContainer" style="margin-bottom:10px;"></div>
                <div style="display:flex; gap:8px;">
                    <input type="email" id="newAlertEmail" placeholder="ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥"
                        style="flex:1; padding:6px 10px; border:1px solid #f5a5a5; border-radius:4px; font-size:13px;">
                    <button onclick="addAlertEmail()"
                        style="background:#dc3545; color:#fff; border:none; border-radius:4px; padding:6px 14px; font-size:13px; cursor:pointer; font-weight:bold;">+
                        ì¶”ê°€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // â”€â”€ ìƒìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const BLOOD_TYPES = ['A', 'B', 'O', 'AB'];

        // ê¸°ë³¸ ìƒì‹œ ì œì œ (ìˆœì„œ = í–‰ ìˆœì„œ)
        // prep_id: BloodMaster í…Œì´ë¸” ID (1~6)
        const BASE_PREPS = [
            { name: 'PRBC', prep_id: 1 },
            { name: 'Pre-R', prep_id: 2 },
            { name: 'PC', prep_id: 3 },
            { name: 'SDP', prep_id: 4 },
            { name: 'FFP', prep_id: 5 },
            { name: 'Cryo', prep_id: 6 },
        ];

        // ì‚¬ìš©ì ì¶”ê°€ ì œì œ (ë™ì )
        // prep_id: null â†’ ì €ì¥ ì‹œ ì œì œëª… í…ìŠ¤íŠ¸ë¡œ remarkì— í¬í•¨
        let customPreps = [];

        let token = localStorage.getItem('bbms_token') || null;
        let currentUser = JSON.parse(localStorage.getItem('bbms_currentUser') || 'null');
        let safetyTargets = {};  // key: `${bt}_${prepName}` â†’ target_qty
        let originalSF = {};     // key: `${bt}` â†’ original safety_factor value

        // â”€â”€ í…Œì´ë¸” í—¤ë” ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function buildHeader() {
            const head = document.getElementById('gridHead');
            const tr = document.createElement('tr');
            tr.innerHTML =
                `<th class="prep-header">ì œì œ</th>` +
                BLOOD_TYPES.map(bt =>
                    `<th class="bt-header bt-${bt}">${bt}</th>`
                ).join('');
            head.innerHTML = '';
            head.appendChild(tr);
        }

        // ì‹ ì²­ëŸ‰ í‘œì‹œ ëŒ€ìƒ ì œì œ
        const REQ_PREPS = ['PRBC', 'Pre-R', 'FFP', 'Cryo'];

        // â”€â”€ í•œ ì œì œì˜ ì…ë ¥ í–‰ + ì‹ ì²­ëŸ‰ í–‰ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function makePrepRows(prepName, prepId, isCustom) {
            const inputRow = document.createElement('tr');
            inputRow.dataset.prep = prepName;

            inputRow.innerHTML =
                `<td class="prep-cell${isCustom ? ' custom-row' : ''}">${prepName}</td>` +
                BLOOD_TYPES.map(bt => {
                    if (prepName === 'Cryo' && bt !== 'AB') {
                        return `<td class="qty-cell" style="background: #fafafa;"></td>`;
                    }
                    const id = cellId(bt, prepName);
                    return `
          <td class="qty-cell">
            <div class="qty-wrap">
              <button class="qty-btn" type="button"
                onclick="changeQty('${id}',-1)">âˆ’</button>
              <input class="qty-input" type="text" inputmode="decimal"
                id="${id}" placeholder="0"
                oninput="onQtyInput('${bt}','${prepName}',this.value)">
              <button class="qty-btn" type="button"
                onclick="changeQty('${id}',+1)">+</button>
            </div>
          </td>`;
                }).join('');

            // ì‹ ì²­ëŸ‰ í–‰: PRBC, Pre-R, FFPë§Œ í‘œì‹œ
            if (!REQ_PREPS.includes(prepName)) return [inputRow];

            const reqRow = document.createElement('tr');
            reqRow.className = 'req-row';
            reqRow.dataset.prep = prepName;
            reqRow.innerHTML =
                `<td class="prep-cell" style="font-size:9px;color:#bbb;">ì‹ ì²­ëŸ‰</td>` +
                BLOOD_TYPES.map(bt =>
                    `<td><span class="req-val zero" id="req_${cellId(bt, prepName)}">-</span></td>`
                ).join('');

            return [inputRow, reqRow];
        }

        // â”€â”€ ì „ì²´ tbody ì¬êµ¬ì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function buildBody() {
            const tbody = document.getElementById('gridBody');
            tbody.innerHTML = '';
            const allPreps = [
                ...BASE_PREPS.map(p => ({ ...p, isCustom: false })),
                ...customPreps.map(p => ({ ...p, isCustom: true })),
            ];
            allPreps.forEach(p => {
                const rows = makePrepRows(p.name, p.prep_id, p.isCustom);
                rows.forEach(r => tbody.appendChild(r));
            });
            recalcAll();
        }

        function cellId(bt, prepName) {
            return `${bt}__${prepName.replace(/\s+/g, '_')}`;
        }

        // â”€â”€ ìˆ˜ëŸ‰ Â±ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function changeQty(id, delta) {
            const el = document.getElementById(id);
            if (!el) return;
            const next = Math.max(0, (parseInt(el.value) || 0) + delta);
            el.value = next;
            const [bt, rawPrep] = id.split('__');
            const prepName = rawPrep.replace(/_/g, ' ');
            onQtyInput(bt, prepName, next);
        }

        // â”€â”€ ì‹ ì²­ëŸ‰ ì‹¤ì‹œê°„ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function onQtyInput(bt, prepName, value) {
            const current = parseInt(value) || 0;
            const key = `${bt}_${prepName}`;
            const target = safetyTargets[key] || 0;
            const req = Math.max(0, target - current);
            const el = document.getElementById(`req_${cellId(bt, prepName)}`);
            if (!el) return;
            if (target === 0) { el.textContent = '-'; el.className = 'req-val zero'; }
            else { el.textContent = req; el.className = 'req-val' + (req === 0 ? ' ok' : ''); }
        }

        function recalcAll() {
            const allPreps = [...BASE_PREPS.map(p => p.name), ...customPreps.map(p => p.name)];
            BLOOD_TYPES.forEach(bt => {
                allPreps.forEach(prepName => {
                    const el = document.getElementById(cellId(bt, prepName));
                    if (el) onQtyInput(bt, prepName, el.value);
                });
            });
        }

        // â”€â”€ API ê³µí†µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function api(method, path, body) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const res = await fetch(path, {
                method,
                headers,
                body: body ? JSON.stringify(body) : undefined
            });
            const data = await res.json().catch(() => ({}));
            return { ok: res.ok, status: res.status, data };
        }

        // â”€â”€ ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            showLoading(true); hideMsg();
            try {
                const res = await api('POST', '/api/auth/login', {
                    emp_id: document.getElementById('empId').value.trim(),
                    password: document.getElementById('password').value
                });
                if (res.ok) {
                    token = res.data.access_token;
                    currentUser = res.data;
                    localStorage.setItem('bbms_token', token);
                    localStorage.setItem('bbms_currentUser', JSON.stringify(currentUser));

                    document.getElementById('loginSection').classList.remove('active');
                    document.getElementById('userInfo').classList.add('active');
                    document.getElementById('userName').textContent = res.data.name + ' ë‹˜';
                    const btnUserManager = document.getElementById('btnUserManager');
                    if (btnUserManager) btnUserManager.style.display = res.data.is_admin ? 'inline-block' : 'none';
                    const btnAnalytics = document.getElementById('btnAnalytics');
                    if (btnAnalytics) btnAnalytics.style.display = 'inline-block';
                    showMsg('ë¡œê·¸ì¸ ì„±ê³µ! ê¸°ì¤€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'success');
                    // ë¡œê·¸ì¸ í›„ ì ì •ì¬ê³  ê¸°ì¤€ë§Œ ë¡œë“œ (ìµœê·¼ ì¬ê³ ëŠ” ë¶ˆëŸ¬ì˜¤ì§€ ì•ŠìŒ)
                    await loadSafetyTargets();
                    await loadRbcFactors();
                    // ê´€ë¦¬ìì—ê²Œë§Œ ì•ŒëŒ ì´ë©”ì¼ ê´€ë¦¬ ì„¹ì…˜ í‘œì‹œ
                    const emailSec = document.getElementById('emailConfigSection');
                    if (emailSec) {
                        emailSec.style.display = res.data.is_admin ? 'block' : 'none';
                        if (res.data.is_admin) loadAlertEmails();
                    }
                    showMsg('ë¡œê·¸ì¸ ì„±ê³µ', 'success');
                } else {
                    showMsg('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (res.data.detail || 'ì¸ì¦ ì˜¤ë¥˜'), 'error');
                }
            } catch (err) {
                showMsg('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + err.message, 'error');
            }
            showLoading(false);
        });

        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('bbms_token');
            localStorage.removeItem('bbms_currentUser');
            document.getElementById('loginSection').classList.add('active');
            document.getElementById('userInfo').classList.remove('active');
            const btnUserManager = document.getElementById('btnUserManager');
            if (btnUserManager) btnUserManager.style.display = 'none';
            const btnAnalytics = document.getElementById('btnAnalytics');
            if (btnAnalytics) btnAnalytics.style.display = 'none';
            hideMsg();
        }

        // â”€â”€ ìµœê·¼ ì¬ê³  ë¶ˆëŸ¬ì˜¤ê¸° (ë¡œê·¸ì¸ ì§í›„ inputì— value ì„¸íŒ…) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadInventory() {
            try {
                const res = await api('GET', '/api/inventory/status');
                if (!res.ok || !res.data.items) return;
                res.data.items.forEach(item => {
                    const prep = item.preparation === 'Prefiltered' ? 'Pre-R' : item.preparation;
                    const id = cellId(item.blood_type, prep);
                    const el = document.getElementById(id);
                    if (el && item.current_qty != null) {
                        el.value = item.current_qty;
                        // ì‹ ì²­ëŸ‰ ì¦‰ì‹œ ê³„ì‚°
                        onQtyInput(item.blood_type, prep, item.current_qty);
                    }
                });
            } catch (_) { }
        }

        // â”€â”€ ì ì •ì¬ê³  ì¡°íšŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadSafetyTargets() {
            try {
                const res = await api('GET', '/api/inventory/status');
                if (res.ok && res.data.items) {
                    safetyTargets = {};
                    res.data.items.forEach(item => {
                        if (item.target_qty != null) {
                            // Prefiltered â†’ Pre-R ë§¤í•‘
                            const prep = item.preparation === 'Prefiltered' ? 'Pre-R' : item.preparation;
                            safetyTargets[`${item.blood_type}_${prep}`] = item.target_qty;
                        }
                    });
                    recalcAll();
                }
            } catch (_) { }
        }

        // â”€â”€ ì¬ê³  ì €ì¥ â€” bulk-save API ì‚¬ìš© (qty=ì ˆëŒ€ê°’, ì €ì¥í›„ ìˆ˜ëŸ‰ ìœ ì§€) â”€â”€â”€â”€â”€â”€
        async function submitForm() {
            if (!currentUser) { showMsg('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”', 'error'); return; }

            const remark = document.getElementById('remark').value.trim();

            // ì…ë ¥ëœ ì…€ ìˆ˜ì§‘ (ê°’ì´ ìˆëŠ” ê²ƒë§Œ)
            const items = [];
            const allPreps = [...BASE_PREPS, ...customPreps];

            allPreps.forEach(p => {
                if (!p.prep_id) return;  // ì»¤ìŠ¤í…€ ì œì œ(prep_id=null)ëŠ” bulk-save ì œì™¸
                BLOOD_TYPES.forEach(bt => {
                    const el = document.getElementById(cellId(bt, p.name));
                    if (!el || el.value === '') return;  // ë¹ˆ ì¹¸ì€ ìŠ¤í‚µ
                    items.push({
                        blood_type: bt,
                        prep_id: p.prep_id,
                        qty: parseInt(el.value) || 0
                    });
                });
            });

            if (items.length === 0) { showMsg('ì…ë ¥ëœ ìˆ˜ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }

            const expiryOk = document.getElementById('expiryOk') ? document.getElementById('expiryOk').checked : true;
            const visualOk = document.getElementById('visualOk') ? document.getElementById('visualOk').checked : true;

            showLoading(true); hideMsg();
            try {
                const res = await api('POST', '/api/inventory/bulk-save', {
                    items,
                    remark: remark || null,
                    user_id: currentUser.user_id,
                    expiry_ok: expiryOk,
                    visual_ok: visualOk
                });

                if (res.ok) {
                    const d = res.data;
                    if (d.failed === 0) {
                        showMsg('ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    } else {
                        showMsg(`âš ï¸ ${d.success}ê°œ ì„±ê³µ / ${d.failed}ê°œ ì‹¤íŒ¨`, 'error');
                    }
                    // ğŸš¨ ìœ„í—˜ì¬ê³  ê°ì§€ ì‹œ ì‚¬ìœ  ì…ë ¥ íŒì—…
                    if (d.danger_alerts && d.danger_alerts.length > 0) {
                        for (const da of d.danger_alerts) {
                            const msg = `ğŸš¨ [ìœ„í—˜ì¬ê³  ê²½ë³´]\n\n` +
                                `í˜ˆì•¡í˜•: ${da.blood_type}í˜• RBC\n` +
                                `í˜„ì¬ì¬ê³ : ${da.rbc_qty} Unit\n` +
                                `í˜„ì¬ì¬ê³ ë¹„: ${da.actual_ratio} (ìœ„í—˜ê¸°ì¤€: ${da.danger_threshold})\n\n` +
                                `ìœ„í—˜ì¬ê³  ë°œìƒ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`;
                            const reason = prompt(msg);
                            // ì·¨ì†Œí•´ë„ ê¸°ë¡ (reason=null â†’ 'ì‚¬ìœ ë¯¸ì…ë ¥')
                            await api('POST', '/api/danger-alerts/', {
                                blood_type: da.blood_type,
                                rbc_qty: da.rbc_qty,
                                danger_threshold: da.danger_threshold,
                                actual_ratio: da.actual_ratio,
                                reason: reason || '(ì‚¬ìœ  ë¯¸ì…ë ¥)',
                                user_id: currentUser?.user_id || null
                            });
                        }
                    }
                } else {
                    showMsg('ì €ì¥ ì‹¤íŒ¨: ' + (res.data.detail || 'ì„œë²„ ì˜¤ë¥˜'), 'error');
                }
            } catch (err) {
                showMsg('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + err.message, 'error');
            }

            showLoading(false);
            // ìˆ˜ëŸ‰ì€ ìœ ì§€, ì‹ ì²­ëŸ‰ë§Œ ì¬ê³„ì‚°
            await loadSafetyTargets();
        }

        // â”€â”€ ìˆ˜ëŸ‰ë§Œ ì´ˆê¸°í™” (remark ìœ ì§€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function clearQty() {
            document.querySelectorAll('.qty-input').forEach(el => el.value = '');
            document.querySelectorAll('.req-val').forEach(el => {
                el.textContent = '-'; el.className = 'req-val zero';
            });
            hideMsg();
        }

        // â”€â”€ ë™ì  ì œì œ ì¶”ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showAddPrepForm() {
            document.getElementById('addPrepForm').classList.add('active');
            document.getElementById('newPrepName').focus();
        }
        function hideAddPrepForm() {
            document.getElementById('addPrepForm').classList.remove('active');
            document.getElementById('newPrepName').value = '';
        }
        function confirmAddPrep() {
            const name = document.getElementById('newPrepName').value;
            if (!name) { showMsg('ì¶”ê°€í•  ì œì œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }

            const allNames = [...BASE_PREPS.map(p => p.name), ...customPreps.map(p => p.name)];
            if (allNames.includes(name)) { showMsg('ì´ë¯¸ ì¶”ê°€ëœ ì œì œì…ë‹ˆë‹¤', 'error'); return; }

            customPreps.push({ name, prep_id: null });
            // ì„ íƒëœ í•­ëª©ì„ ë“œë¡­ë‹¤ìš´ì—ì„œ ë¹„í™œì„±í™”
            const opt = document.querySelector(`#newPrepName option[value="${name}"]`);
            if (opt) opt.disabled = true;
            document.getElementById('newPrepName').value = '';
            buildBody();
            hideAddPrepForm();
            showMsg(`"${name}" í–‰ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            // ìƒˆ í–‰ì— Enter í¬ì»¤ìŠ¤ ì´ë™ ì´ë²¤íŠ¸ ì¬ë“±ë¡
            attachEnterNavigation();
        }

        // â”€â”€ Enter í‚¤ â†’ ì˜¤ë¥¸ìª½(Aâ†’Bâ†’Oâ†’AB) í¬ì»¤ìŠ¤ ìë™ ì´ë™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function attachEnterNavigation() {
            // ëª¨ë“  qty-inputì— ì´ë²¤íŠ¸ ë‹¬ê¸° (ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ì¡´ í•¸ë“¤ëŸ¬ ì œê±°)
            document.querySelectorAll('.qty-input').forEach(el => {
                el.removeEventListener('keydown', handleEnterKey);
                el.addEventListener('keydown', handleEnterKey);
            });
        }
        function handleEnterKey(e) {
            if (e.key !== 'Enter') return;
            e.preventDefault();

            // í˜„ì¬ inputì˜ id = "BT__PrepName"
            const [curBt, rawPrep] = this.id.split('__');
            const prepName = rawPrep.replace(/_/g, ' ');

            // ê°™ì€ ì œì œ í–‰ì—ì„œ ë‹¤ìŒ í˜ˆì•¡í˜•ìœ¼ë¡œ ì´ë™
            const btIdx = BLOOD_TYPES.indexOf(curBt);
            const nextBt = BLOOD_TYPES[btIdx + 1];   // ì—†ìœ¼ë©´ undefined

            if (nextBt) {
                const nextEl = document.getElementById(cellId(nextBt, prepName));
                if (nextEl) { nextEl.focus(); nextEl.select(); }
            } else {
                // ë§ˆì§€ë§‰ ì—´(AB)ì´ë©´ ë‹¤ìŒ í–‰ì˜ Aì¹¸ìœ¼ë¡œ ì´ë™
                const allPreps = [...BASE_PREPS.map(p => p.name), ...customPreps.map(p => p.name)];
                const prepIdx = allPreps.indexOf(prepName);
                const nextPrep = allPreps[prepIdx + 1];
                if (nextPrep) {
                    const nextEl = document.getElementById(cellId('A', nextPrep));
                    if (nextEl) { nextEl.focus(); nextEl.select(); }
                }
            }
        }

        // â”€â”€ RBC ì¬ê³ ë¹„ ê´€ë¦¬ (í˜ˆì•¡í˜•ë³„ ê¶Œí•œ ë¶„ë¦¬) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadRbcFactors() {
            if (!currentUser) return;
            const container = document.getElementById('rbcConfigContainer');
            if (!container) return;
            container.innerHTML = '<div style="text-align:center; padding:10px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const res = await api('GET', '/api/config/rbc-factors');
                if (res.ok) {
                    const data = res.data;
                    let html = '';

                    BLOOD_TYPES.forEach(bt => {
                        // ì •í™•íˆ ë§¤ì¹­ë˜ê±°ë‚˜ ê³µí†µ fallback
                        const exact = data.find(c => c.blood_type === bt && c.prep_id === null);
                        const common = data.find(c => c.blood_type === null && c.prep_id === null);
                        const fallback = { daily_consumption_rate: 3.0, safety_factor: 2.0, danger_factor: null };
                        const conf = exact || common || fallback;

                        originalSF[bt] = conf.safety_factor;

                        // ê¶Œí•œ ì²´í¬: ê´€ë¦¬ìë§Œ DCR ìˆ˜ì • ê°€ëŠ¥
                        const dcrDisabled = currentUser.is_admin ? '' : 'disabled';
                        const dcrColor = currentUser.is_admin ? '' : 'background-color:#eaeaea; color:#888;';

                        // í˜ˆì•¡í˜• í‘œì‹œ ìƒ‰ìƒ
                        let btColor = '#333';
                        if (bt === 'A') btColor = '#e65100';
                        if (bt === 'B') btColor = '#b71c1c';
                        if (bt === 'O') btColor = '#0d47a1';

                        html += `
                        <div style="display:flex; gap:6px; align-items:center; background:#fff; padding:6px; border-radius:6px; border:1px solid #c9bef0;" class="rbc-row" data-bt="${bt}">
                            <div style="width:30px; font-weight:900; text-align:center; color:${btColor}; font-size:14px;">${bt}</div>
                            <div style="flex:1;">
                                <label style="font-size:10px; color:#555; display:block; margin-bottom:2px;">1ì¼ ì¬ê³ </label>
                                <input type="number" id="dcr_${bt}" value="${conf.daily_consumption_rate}" step="0.1" min="0.1" max="30" inputmode="decimal" style="width:100%; padding:4px 6px; font-size:12px; border:1px solid #ccc; border-radius:4px; ${dcrColor}" ${dcrDisabled}>
                            </div>
                            <div style="flex:1;">
                                <label style="font-size:10px; color:#555; display:block; margin-bottom:2px;">ì ì •ì¬ê³ ë¹„(SF)</label>
                                <input type="number" id="sf_${bt}" value="${conf.safety_factor}" step="0.1" min="0.5" max="10" inputmode="decimal" style="width:100%; padding:4px 6px; font-size:12px; border:1px solid #ccc; border-radius:4px;">
                            </div>
                            <div style="flex:1;">
                                <label style="font-size:10px; color:#dc3545; display:block; margin-bottom:2px;">âš ï¸ ìœ„í—˜ì¬ê³ ë¹„(DF)</label>
                                <input type="number" id="df_${bt}" value="${conf.danger_factor ?? ''}" step="0.1" min="0.1" max="10" inputmode="decimal" placeholder="ì˜ˆ: 2.0" style="width:100%; padding:4px 6px; font-size:12px; border:1px solid #f5a5a5; border-radius:4px; background:#fff8f8;">
                            </div>
                        </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="color:red; font-size:12px;">ì„¤ì • ë¡œë“œ ì‹¤íŒ¨</div>';
                }
            } catch (e) {
                container.innerHTML = '<div style="color:red; font-size:12px;">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</div>';
            }
        }

        async function saveAllRbcFactors() {
            const reason = document.getElementById('adminReason').value.trim();

            let sfChanged = false;
            for (const bt of BLOOD_TYPES) {
                const sf = parseFloat(document.getElementById('sf_' + bt).value);
                if (sf !== originalSF[bt]) {
                    sfChanged = true;
                }
            }

            if (sfChanged && reason.length < 5) {
                showMsg('ì ì •ì¬ê³ ë¹„(SF) ë³€ê²½ì‹œ ì¬ê³ ë¹„ ë³€ê²½ì‚¬ìœ ëŠ” 5ì ì´ìƒ í•„ìˆ˜ì…ë‹ˆë‹¤', 'error');
                return;
            }

            const finalReason = reason || "1ì¼ì¬ê³  ìˆ˜ì •";

            const payloads = [];
            for (const bt of BLOOD_TYPES) {
                const dcr = parseFloat(document.getElementById('dcr_' + bt).value);
                const sf = parseFloat(document.getElementById('sf_' + bt).value);

                if (isNaN(dcr) || dcr <= 0) { showMsg(bt + 'í˜• 1ì¼ ì¬ê³ ë¥¼ í™•ì¸í•˜ì„¸ìš”', 'error'); return; }
                if (isNaN(sf) || sf <= 0) { showMsg(bt + 'í˜• ì ì •ì¬ê³ ë¹„ë¥¼ í™•ì¸í•˜ì„¸ìš”', 'error'); return; }

                payloads.push({
                    daily_consumption_rate: dcr,
                    safety_factor: sf,
                    danger_factor: isNaN(parseFloat(document.getElementById('df_' + bt)?.value)) ? null : parseFloat(document.getElementById('df_' + bt).value),
                    change_reason: finalReason,
                    blood_type: bt,
                    changed_by: currentUser.emp_id
                });
            }

            showLoading(true); hideMsg();
            let successCount = 0;
            try {
                for (const p of payloads) {
                    const res = await api('PUT', '/api/config/rbc-factors', p);
                    if (!res.ok) throw new Error(`${p.blood_type}í˜• ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ` + (res.data.detail || 'ì˜¤ë¥˜'));
                    successCount++;
                }

                if (successCount === 4) {
                    showMsg(`RBC ì¬ê³ ë¹„ ì„¤ì •(4ê°œ í˜ˆì•¡í˜•) ì¼ê´„ ì €ì¥ ì™„ë£Œ`, 'success');
                    await loadSafetyTargets();
                    document.getElementById('adminReason').value = '';
                }
            } catch (err) {
                showMsg('ì„œë²„ ì˜¤ë¥˜: ' + err.message, 'error');
            }
            showLoading(false);
        }

        // â”€â”€ ì•ŒëŒ ì´ë©”ì¼ ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadAlertEmails() {
            const cont = document.getElementById('emailListContainer');
            if (!cont) return;
            try {
                const res = await api('GET', '/api/alert-emails/');
                if (!res.ok || !res.data.length) {
                    cont.innerHTML = '<div style="color:#888; font-size:12px;">ë“±ë¡ëœ ì´ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                cont.innerHTML = res.data.map(e =>
                    `<div style="display:flex; justify-content:space-between; align-items:center; padding:4px 8px; background:#fff; border:1px solid #ddd; border-radius:4px; margin-bottom:4px;">
                        <span style="font-size:12px;">${e.email}</span>
                        <button onclick="deleteAlertEmail(${e.id})" style="background:#dc3545; color:#fff; border:none; border-radius:3px; padding:2px 8px; cursor:pointer; font-size:11px;">ì‚­ì œ</button>
                    </div>`
                ).join('');
            } catch (e) { cont.innerHTML = '<div style="color:red; font-size:12px;">ì˜¤ë¥˜</div>'; }
        }

        async function addAlertEmail() {
            const inp = document.getElementById('newAlertEmail');
            if (!inp || !inp.value.trim()) { showMsg('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
            const res = await api('POST', '/api/alert-emails/', { email: inp.value.trim() });
            if (res.ok) { inp.value = ''; loadAlertEmails(); showMsg('ì´ë©”ì¼ ë“±ë¡ ì™„ë£Œ', 'success'); }
            else showMsg(res.data.detail || 'ë“±ë¡ ì‹¤íŒ¨', 'error');
        }

        async function deleteAlertEmail(id) {
            if (!confirm('ì´ ì´ë©”ì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const res = await api('DELETE', `/api/alert-emails/${id}`);
            if (res.ok) { loadAlertEmails(); showMsg('ì‚­ì œ ì™„ë£Œ', 'success'); }
            else showMsg(res.data.detail || 'ì‚­ì œ ì‹¤íŒ¨', 'error');
        }

        // â”€â”€ ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë‹¬ ë¡œì§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openUserModal() {
            document.getElementById('userModal').classList.add('active');
            loadUsers();
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        async function loadUsers() {
            try {
                const res = await api('GET', '/api/users/');
                if (!res.ok) throw new Error(res.data?.detail || 'ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');

                const tbody = document.querySelector('#userTable tbody');
                tbody.innerHTML = '';

                res.data.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${user.emp_id}</td>
                        <td>${user.name}</td>
                        <td>
                            <select onchange="updateUserRole(${user.id}, this.value)" style="padding:2px; font-size:11px;">
                                <option value="0" ${user.is_admin === 0 ? 'selected' : ''}>ì¼ë°˜</option>
                                <option value="1" ${user.is_admin === 1 ? 'selected' : ''}>ê´€ë¦¬ì</option>
                            </select>
                        </td>
                        <td>
                            <button class="btn-small btn-warning" onclick="resetPassword(${user.id}, '${user.name}')">PWë³€ê²½</button>
                            <button class="btn-small btn-danger" onclick="deleteUser(${user.id}, '${user.name}')">ì‚­ì œ</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                alert(e.message);
            }
        }

        async function createUser() {
            const empId = document.getElementById('newEmpId').value.trim();
            const name = document.getElementById('newName').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const role = parseInt(document.getElementById('newRole').value);

            if (!empId || !name || !password) {
                alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return;
            }

            try {
                const res = await api('POST', '/api/users/', {
                    emp_id: empId,
                    name: name,
                    password: password,
                    is_admin: role
                });

                if (res.ok) {
                    alert('ì‚¬ìš©ì ë“±ë¡ ì™„ë£Œ');
                    document.getElementById('newEmpId').value = '';
                    document.getElementById('newName').value = '';
                    document.getElementById('newPassword').value = '';
                    loadUsers();
                } else {
                    alert(res.data?.detail || 'ë“±ë¡ ì‹¤íŒ¨');
                }
            } catch (e) {
                alert("ì„œë²„ ì˜¤ë¥˜: " + e.message);
            }
        }

        async function updateUserRole(userId, newRole) {
            try {
                const res = await api('PUT', `/api/users/${userId}`, { is_admin: parseInt(newRole) });
                if (!res.ok) throw new Error(res.data?.detail || 'ê¶Œí•œ ë³€ê²½ ì‹¤íŒ¨');
                alert('ê¶Œí•œì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadUsers();
            } catch (e) {
                alert(e.message);
                loadUsers();
            }
        }

        async function resetPassword(userId, userName) {
            const newPw = prompt(`[${userName}] ë‹˜ì˜ ì´ˆê¸°í™”í•  ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
            if (!newPw) return;

            try {
                const res = await api('POST', `/api/users/${userId}/reset-password`, { new_password: newPw });
                if (!res.ok) throw new Error(res.data?.detail || 'ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì‹¤íŒ¨');
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (e) {
                alert(e.message);
            }
        }

        async function deleteUser(userId, userName) {
            if (!confirm(`ì •ë§ë¡œ [${userName}] ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const res = await api('DELETE', `/api/users/${userId}`);
                if (!res.ok) throw new Error(res.data?.detail || 'ì‚­ì œ ì‹¤íŒ¨');
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadUsers();
            } catch (e) {
                alert(e.message);
            }
        }

        // â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showMsg(text, type) {
            const m = document.getElementById('message');
            m.textContent = text;
            m.className = 'message ' + type + ' active';
            clearTimeout(m._timer);
            m._timer = setTimeout(hideMsg, 6000);
        }
        function hideMsg() { document.getElementById('message').classList.remove('active'); }
        function showLoading(show) { document.getElementById('loading').classList.toggle('active', show); }

        // â”€â”€ ì—‘ì…€ ì—…ë¡œë“œ ë¡œì§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // â”€â”€ ì—‘ì…€ ì—…ë¡œë“œ ë¡œì§ (í†µê³„ ì „ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function handleExcelUpload(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append("files", files[i]);
            }

            // ì—…ë¡œë“œ ì¦‰ì‹œ í†µê³„ í…Œì´ë¸”(InboundHistory)ë¡œ ì €ì¥ (í™”ë©´ ì±„ìš°ê¸° ì—†ìŒ)
            showLoading(true); hideMsg();
            try {
                const res = await fetch('/api/inventory/upload', {
                    method: 'POST',
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                    body: formData
                });
                const data = await res.json();

                if (res.ok) {
                    showMsg(`âœ… ì—‘ì…€ í†µê³„ì—…ë¡œë“œ ì™„ë£Œ: íŒŒì‹±ëœ íŒŒì¼ìˆ˜ ${data.files_processed}ê±´, ì €ì¥ëœ ì´ ìˆ˜ëŸ‰ ${data.total_qty_saved} units`, 'success');
                } else {
                    showMsg(data.detail || 'ì—‘ì…€ ì—…ë¡œë“œ ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                showMsg('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message, 'error');
            }
            showLoading(false);
            e.target.value = ''; // ë™ì¼ íŒŒì¼ ì¬ì—…ë¡œë“œ ì§€ì›
        }


        // â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function restoreLoginState() {
            if (token && currentUser) {
                document.getElementById('loginSection').classList.remove('active');
                document.getElementById('userInfo').classList.add('active');
                document.getElementById('userName').textContent = currentUser.name + ' ë‹˜';
                const btnUserManager = document.getElementById('btnUserManager');
                if (btnUserManager) btnUserManager.style.display = currentUser.is_admin ? 'inline-block' : 'none';
                const btnAnalytics = document.getElementById('btnAnalytics');
                if (btnAnalytics) btnAnalytics.style.display = 'inline-block';

                loadSafetyTargets();
                loadRbcFactors();
            }
        }

        buildHeader();
        buildBody();
        restoreLoginState();
        attachEnterNavigation();   // Enterí‚¤ í¬ì»¤ìŠ¤ ì´ë™ ì´ˆê¸° ë“±ë¡
    </script>
</body>

</html>