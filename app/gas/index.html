<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SCHBC BBMS - í˜ˆì•¡ ì¬ê³  ì…ë ¥</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      background: #f0f2f5;
      padding: 8px;
      -webkit-text-size-adjust: 100%;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      overflow: hidden;
    }

    /* â”€â”€ í—¤ë” â”€â”€ */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 14px 16px;
      text-align: center;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .header p {
      font-size: 12px;
      opacity: 0.9;
    }

    /* â”€â”€ ë¡œê·¸ì¸ â”€â”€ */
    .login-section {
      padding: 12px 16px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      display: none;
    }

    .login-section.active {
      display: block;
    }

    .login-form {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .login-form input {
      flex: 1;
      padding: 9px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .login-form button {
      padding: 9px 18px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .login-form button:active {
      background: #5568d3;
    }

    .user-info {
      display: none;
      padding: 8px 14px;
      background: #e8f5e9;
      border-radius: 6px;
      font-size: 13px;
    }

    .user-info.active {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logout-btn {
      background: none;
      border: 1px solid #aaa;
      border-radius: 4px;
      padding: 3px 8px;
      font-size: 12px;
      cursor: pointer;
      color: #555;
    }

    /* â”€â”€ ê·¸ë¦¬ë“œ â”€â”€ */
    .grid-section {
      padding: 10px 8px;
      overflow-x: auto;
    }

    .grid-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .grid-table th {
      background: #f0f2ff;
      padding: 7px 4px;
      text-align: center;
      font-weight: 700;
      border: 1px solid #d0d0e8;
      font-size: 11px;
      white-space: nowrap;
      color: #444;
    }

    .grid-table td {
      padding: 3px 3px;
      border: 1px solid #e0e0e0;
      text-align: center;
      vertical-align: middle;
    }

    .grid-table td.blood-type-cell {
      background: #f5f5f5;
      font-weight: 700;
      font-size: 14px;
      width: 32px;
    }

    .grid-table td.blood-type-cell.O-type {
      background: #fff0e8;
      color: #c43c00;
    }

    /* â”€â”€ ì…ë ¥ + ë²„íŠ¼ â”€â”€ */
    .qty-cell {
      min-width: 72px;
      padding: 3px !important;
    }

    .qty-wrap {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .qty-btn {
      width: 22px;
      height: 28px;
      flex-shrink: 0;
      border: 1px solid #bbb;
      border-radius: 4px;
      background: #f5f5f5;
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
      color: #444;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-user-select: none;
    }

    .qty-btn:active {
      background: #dde;
    }

    .qty-input {
      flex: 1;
      min-width: 0;
      padding: 5px 2px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      appearance: textfield;
      -webkit-appearance: none;
      -moz-appearance: textfield;
    }

    .qty-input:focus {
      outline: none;
      border-color: #667eea;
      background: #f0f4ff;
    }

    /* Chrome ìŠ¤í•€ ë²„íŠ¼ ì œê±° */
    .qty-input::-webkit-inner-spin-button,
    .qty-input::-webkit-outer-spin-button {
      appearance: none;
      -webkit-appearance: none;
      margin: 0;
    }

    /* â”€â”€ ì‹ ì²­ëŸ‰ í–‰ â”€â”€ */
    .request-row td {
      background: #fffde7;
      font-size: 11px;
      padding: 3px 4px;
      color: #6b4500;
      font-weight: 600;
    }

    .request-row td.blood-type-cell {
      background: #fff8e1;
      font-size: 11px;
      color: #6b4500;
    }

    .req-val {
      font-size: 13px;
      color: #c84000;
      font-weight: 700;
    }

    .req-val.ok {
      color: #2e7d32;
    }

    .req-val.zero {
      color: #aaa;
    }

    /* â”€â”€ í•˜ë‹¨ â”€â”€ */
    .bottom-section {
      padding: 12px 16px;
      background: #f8f9fa;
      border-top: 1px solid #e0e0e0;
    }

    .remark-group {
      margin-bottom: 10px;
    }

    .remark-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 13px;
    }

    .remark-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      resize: vertical;
      min-height: 56px;
      font-family: inherit;
    }

    .button-group {
      display: flex;
      gap: 8px;
    }

    .btn {
      flex: 1;
      padding: 13px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:active {
      transform: scale(0.97);
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    /* â”€â”€ ë©”ì‹œì§€ / ë¡œë”© â”€â”€ */
    .message {
      padding: 10px 14px;
      margin: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message.active {
      display: block;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 16px;
      color: #667eea;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 0.9s linear infinite;
      margin: 0 auto 8px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* â”€â”€ ê´€ë¦¬ì íŒ¨ë„ (PC ì „ìš©) â”€â”€ */
    .admin-panel {
      display: none;
      /* ê¸°ë³¸ ìˆ¨ê¹€ */
      padding: 14px 16px;
      border-top: 2px solid #667eea;
      background: #f5f3ff;
    }

    .admin-panel h3 {
      font-size: 14px;
      color: #5541a8;
      margin-bottom: 12px;
      font-weight: 700;
    }

    .admin-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .admin-field label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #555;
      margin-bottom: 4px;
    }

    .admin-field input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #c9bef0;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }

    .admin-field input:focus {
      outline: none;
      border-color: #667eea;
    }

    .admin-reason label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #555;
      margin-bottom: 4px;
    }

    .admin-reason textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #c9bef0;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      min-height: 48px;
      resize: vertical;
      background: white;
    }

    .admin-apply-btn {
      margin-top: 10px;
      padding: 10px 20px;
      background: #5541a8;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .admin-apply-btn:active {
      background: #3d2f8a;
    }

    .admin-hint {
      font-size: 11px;
      color: #888;
      margin-top: 6px;
      line-height: 1.5;
    }

    /* PCì—ì„œë§Œ ê´€ë¦¬ì íŒ¨ë„ í‘œì‹œ */
    @media (min-width: 768px) {
      .admin-panel {
        display: block;
      }
    }

    /* â”€â”€ ë°˜ì‘í˜• â”€â”€ */
    @media (max-width: 480px) {
      body {
        padding: 4px;
      }

      .grid-table th,
      .grid-table td {
        font-size: 11px;
      }

      .qty-btn {
        width: 20px;
        height: 26px;
        font-size: 14px;
      }

      .qty-input {
        font-size: 13px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- í—¤ë” -->
    <div class="header">
      <h1>ğŸ©¸ SCHBC BBMS</h1>
      <p>í˜ˆì•¡ ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
    </div>

    <!-- ë¡œê·¸ì¸ -->
    <div class="login-section active" id="loginSection">
      <form class="login-form" id="loginForm">
        <input type="text" id="empId" placeholder="ì‚¬ë²ˆ" autocomplete="username" required>
        <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" required>
        <button type="submit">ë¡œê·¸ì¸</button>
      </form>
    </div>

    <!-- ì‚¬ìš©ì ì •ë³´ -->
    <div class="user-info" id="userInfo">
      <span id="userName"></span>
      <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ë©”ì‹œì§€ / ë¡œë”© -->
    <div class="message" id="message"></div>
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div>ì²˜ë¦¬ ì¤‘...</div>
    </div>

    <!-- ê·¸ë¦¬ë“œ í…Œì´ë¸” -->
    <div class="grid-section">
      <table class="grid-table" id="inventoryGrid">
        <thead>
          <tr>
            <th>í˜ˆì•¡í˜•</th>
            <th>PRBC</th>
            <th>Pre-R</th>
            <th>PC</th>
            <th>SDP</th>
            <th>FFP</th>
            <th>Cryo</th>
          </tr>
        </thead>
        <tbody id="gridBody">
          <!-- JSë¡œ ìƒì„± -->
        </tbody>
      </table>
    </div>

    <!-- í•˜ë‹¨ -->
    <div class="bottom-section">
      <div class="remark-group">
        <label for="remark">ë¹„ê³  (í•„ìˆ˜)</label>
        <textarea id="remark" placeholder="ì…ì¶œê³  ì‚¬ìœ , íŠ¹ì´ì‚¬í•­ ë“±ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      </div>
      <div class="button-group">
        <button class="btn btn-secondary" onclick="clearForm()">ì´ˆê¸°í™”</button>
        <button class="btn btn-primary" onclick="submitForm()">ì¬ê³  ì €ì¥</button>
      </div>
    </div>

    <!-- ê´€ë¦¬ì íŒ¨ë„ (PC ì „ìš©, â‰¥768px) -->
    <div class="admin-panel" id="adminPanel">
      <h3>âš™ï¸ RBC ì¬ê³ ë¹„ ê´€ë¦¬ (ê´€ë¦¬ì / PC ì „ìš©)</h3>
      <div class="admin-grid">
        <div class="admin-field">
          <label for="adminDCR">1ì¼ ì¬ê³ ë¹„ (Daily Consumption Rate)</label>
          <input type="number" id="adminDCR" step="0.1" min="0.1" max="30" value="3.0" inputmode="decimal">
        </div>
        <div class="admin-field">
          <label for="adminSF">ì ì •ì¬ê³ ë¹„ (Safety Factor)</label>
          <input type="number" id="adminSF" step="0.1" min="0.5" max="10" value="2.0" inputmode="decimal">
        </div>
      </div>
      <div class="admin-reason">
        <label for="adminReason">ë³€ê²½ ì‚¬ìœ  (5ì ì´ìƒ í•„ìˆ˜)</label>
        <textarea id="adminReason" placeholder="ì˜ˆ: 2026ë…„ 2ë¶„ê¸° ì‚¬ìš©ëŸ‰ ë¶„ì„ ë°˜ì˜"></textarea>
      </div>
      <button class="admin-apply-btn" onclick="applyRbcFactors()">ğŸ“Š ì „ì²´ ê³µí†µ ì ìš©</button>
      <p class="admin-hint">
        ğŸ’¡ ì ì •ì¬ê³  ê³„ì‚°ì‹: ceil(1ì¼ì¬ê³ ë¹„ Ã— ì ì •ì¬ê³ ë¹„)&nbsp;&nbsp;|&nbsp;&nbsp;Oí˜• RBC: +4 ì¶”ê°€
      </p>
    </div>
  </div>

  <script>
    const BLOOD_TYPES = ['A', 'B', 'O', 'AB'];
    const PREPS = ['PRBC', 'Pre-R', 'PC', 'SDP', 'FFP', 'Cryo'];
    let currentUser = null;
    // ì ì •ì¬ê³  ìºì‹œ (ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ê°’)
    let safetyTargets = {};

    // â”€â”€ ê·¸ë¦¬ë“œ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildGrid() {
      const tbody = document.getElementById('gridBody');
      tbody.innerHTML = '';

      BLOOD_TYPES.forEach(bt => {
        // ì…ë ¥ í–‰
        const inputRow = document.createElement('tr');
        const isO = bt === 'O';
        inputRow.innerHTML = `<td class="blood-type-cell${isO ? ' O-type' : ''}">${bt}</td>`;

        PREPS.forEach(prep => {
          const id = `${bt}_${prep}`;
          inputRow.innerHTML += `
            <td class="qty-cell">
              <div class="qty-wrap">
                <button class="qty-btn" type="button" onclick="changeQty('${id}',-1)">âˆ’</button>
                <input class="qty-input"
                       type="text"
                       inputmode="decimal"
                       id="${id}"
                       placeholder="0"
                       oninput="onQtyInput('${bt}','${prep}',this.value)">
                <button class="qty-btn" type="button" onclick="changeQty('${id}',+1)">+</button>
              </div>
            </td>`;
        });
        tbody.appendChild(inputRow);

        // ì‹ ì²­ëŸ‰ í–‰
        const reqRow = document.createElement('tr');
        reqRow.className = 'request-row';
        reqRow.innerHTML = `<td class="blood-type-cell" style="font-size:10px;color:#aaa;">ì‹ ì²­ëŸ‰</td>`;
        PREPS.forEach(prep => {
          reqRow.innerHTML += `<td><span class="req-val zero" id="req_${bt}_${prep}">-</span></td>`;
        });
        tbody.appendChild(reqRow);
      });
    }

    // â”€â”€ +/- ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function changeQty(id, delta) {
      const input = document.getElementById(id);
      const current = parseInt(input.value) || 0;
      const next = Math.max(0, current + delta);
      input.value = next;
      const [bt, prep] = id.split('_');
      onQtyInput(bt, prep, next);
    }

    // â”€â”€ ì‹ ì²­ëŸ‰ ì‹¤ì‹œê°„ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function onQtyInput(bt, prep, value) {
      const current = parseInt(value) || 0;
      const key = `${bt}_${prep}`;
      const target = safetyTargets[key] || 0;
      const req = Math.max(0, target - current);
      const el = document.getElementById(`req_${bt}_${prep}`);
      if (!el) return;
      el.textContent = target > 0 ? req : '-';
      el.className = 'req-val ' + (target === 0 ? 'zero' : req === 0 ? 'ok' : '');
    }

    // â”€â”€ ì ì •ì¬ê³  ë¶ˆëŸ¬ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadSafetyTargets() {
      google.script.run
        .withSuccessHandler(function (result) {
          if (result && result.success) {
            safetyTargets = result.targets || {};
            // ì´ë¯¸ ì…ë ¥ëœ ê°’ì´ ìˆìœ¼ë©´ ì‹ ì²­ëŸ‰ ì¬ê³„ì‚°
            BLOOD_TYPES.forEach(bt => {
              PREPS.forEach(prep => {
                const el = document.getElementById(`${bt}_${prep}`);
                if (el && el.value) onQtyInput(bt, prep, el.value);
              });
            });
          }
        })
        .withFailureHandler(function () { }) // ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ
        .getSafetyTargets();
    }

    // â”€â”€ ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('loginForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const empId = document.getElementById('empId').value.trim();
      const passw = document.getElementById('password').value;
      showLoading(true); hideMessage();

      google.script.run
        .withSuccessHandler(function (result) {
          showLoading(false);
          if (result.success) {
            currentUser = result.data;
            document.getElementById('loginSection').classList.remove('active');
            const ui = document.getElementById('userInfo'); ui.classList.add('active');
            document.getElementById('userName').textContent = result.data.name;
            showMessage('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
            loadSafetyTargets();
          } else {
            showMessage('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function (e) { showLoading(false); showMessage('ì˜¤ë¥˜: ' + e.message, 'error'); })
        .loginUser({ emp_id: empId, password: passw });
    });

    function logout() {
      currentUser = null;
      document.getElementById('loginSection').classList.add('active');
      document.getElementById('userInfo').classList.remove('active');
      clearForm();
    }

    // â”€â”€ í¼ ì œì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function submitForm() {
      if (!currentUser) { showMessage('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”', 'error'); return; }
      const remark = document.getElementById('remark').value.trim();
      if (!remark) { showMessage('ë¹„ê³ ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

      const formData = { remark };
      let hasData = false;
      BLOOD_TYPES.forEach(bt => {
        PREPS.forEach(prep => {
          const id = `${bt}_${prep}`;
          const v = document.getElementById(id).value;
          if (v !== '' && v !== '0') { formData[id] = v; hasData = true; }
        });
      });
      if (!hasData) { showMessage('ì…ë ¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }

      showLoading(true); hideMessage();
      google.script.run
        .withSuccessHandler(function (result) {
          showLoading(false);
          if (result.success) { showMessage(result.message, 'success'); clearForm(); }
          else { showMessage('ì €ì¥ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error'); }
        })
        .withFailureHandler(function (e) { showLoading(false); showMessage('ì˜¤ë¥˜: ' + e.message, 'error'); })
        .submitData(formData);
    }

    // â”€â”€ ê´€ë¦¬ì: RBC ì¬ê³ ë¹„ ì¼ê´„ ì ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyRbcFactors() {
      const dcr = parseFloat(document.getElementById('adminDCR').value);
      const sf = parseFloat(document.getElementById('adminSF').value);
      const reason = document.getElementById('adminReason').value.trim();

      if (isNaN(dcr) || dcr <= 0) { showMessage('1ì¼ ì¬ê³ ë¹„ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
      if (isNaN(sf) || sf <= 0) { showMessage('ì ì •ì¬ê³ ë¹„ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
      if (reason.length < 5) { showMessage('ë³€ê²½ ì‚¬ìœ ëŠ” 5ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

      showLoading(true); hideMessage();
      google.script.run
        .withSuccessHandler(function (result) {
          showLoading(false);
          if (result && result.success) {
            showMessage(`ì¬ê³ ë¹„ ì ìš© ì™„ë£Œ: DCR=${dcr}, SF=${sf}`, 'success');
            loadSafetyTargets();
          } else {
            showMessage('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (result && result.error || 'ì˜¤ë¥˜'), 'error');
          }
        })
        .withFailureHandler(function (e) { showLoading(false); showMessage('ì˜¤ë¥˜: ' + e.message, 'error'); })
        .updateRbcFactors({ daily_consumption_rate: dcr, safety_factor: sf, change_reason: reason });
    }

    // â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function clearForm() {
      document.querySelectorAll('.qty-input').forEach(i => i.value = '');
      document.getElementById('remark').value = '';
      document.querySelectorAll('.req-val').forEach(el => { el.textContent = '-'; el.className = 'req-val zero'; });
      hideMessage();
    }
    function showMessage(text, type) {
      const m = document.getElementById('message');
      m.textContent = text; m.className = 'message ' + type + ' active';
      setTimeout(hideMessage, 5000);
    }
    function hideMessage() { document.getElementById('message').classList.remove('active'); }
    function showLoading(show) {
      document.getElementById('loading').classList.toggle('active', show);
    }

    // â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    buildGrid();
  </script>
</body>

</html>